<?define version='7.4.!!revision!!' ?>
<?define UpgradeCode = "1DB91230-EBBC-11DD-BA2F-0800200C9A66" ?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<Product
		Name="SqueezeCenter 7.4-!!revision!! for Windows Home Server"
		Id="*"
		UpgradeCode="$(var.UpgradeCode)"
		Manufacturer="Logitech"
		Version="$(var.version)"
		Language="1033">

		<Package
			Manufacturer="Logitech"
			InstallerVersion="200"
			Languages="1033"
			Compressed="yes" />

		<Media Id="1" Cabinet="SqueezeCenter_0.0.0.0.cab" EmbedCab="yes" />

		<Property Id="WHSLogo">1</Property>

		<Condition Message="[ProductName] requires Windows Home Server. For more information, please refer to the User Guide.">VersionNT = 502</Condition>

		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="APPPATH" Name=".">
				<Component Id="SqueezeCenter" Guid="{1DB91230-EBBC-11DD-BA2F-0800200C9A66}">
					<ServiceControl Id="SqueezeSvc" Name="squeezesvc" Start="install" />

					<RemoveRegistryKey Action="removeOnUninstall"
						Root='HKLM'
						Key="SOFTWARE\Microsoft\Windows Home Server\RegisteredAdditions\[ProductCode]" />
				</Component>
			</Directory>

			<Directory Id="ProgramFilesFolder">
				<Directory Id="WHS" Name="Windows Home Server">
					<Component
						Id="HomeServerConsoleTab.SqueezePanel"
						Guid="7f25fe10-f77a-11dd-87af-0800200c9a66">
					
						<File
							Id="HomeServerConsoleTab.SqueezeCenter.dll"
							Name="HomeServerConsoleTab.SqueezeCenter.dll"
							Source="HomeServerConsoleTab.SqueezeCenter.dll"
							Vital="yes"
							KeyPath="yes"
							DiskId="1"/>
					</Component>
				</Directory>
			</Directory>
		</Directory>

		<Property Id="APPPATH">
			<RegistrySearch
				Id="Path" 
				Root="HKLM"
				Key="SOFTWARE\Logitech\SqueezeCenter"
				Name="Path"
				Type="raw"
			/>
		</Property>

		<Property Id="UNINSTALLCOMMAND">
			<RegistrySearch
				Id="QuietUninstallString" 
				Root="HKLM"
				Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\SqueezeCenter_is1"
				Name="QuietUninstallString"
				Type="raw"
			/>
		</Property>

		<Binary Id="SCInstallerFile" SourceFile="SqueezeSetup.exe" />
		
		<Feature Id="SCInstaller" Title="SqueezeCenter Installer" Level="1" AllowAdvertise="no" Display="hidden">
			<ComponentRef Id="SqueezeCenter" />
		</Feature>
		
		<Feature Id="ProductFeature" Title="SqueezePanel" Level="1" AllowAdvertise="no">
			<ComponentRef Id="HomeServerConsoleTab.SqueezePanel" />
		</Feature>
		
		<CustomAction Id="InstallSC" BinaryKey="SCInstallerFile" ExeCommand="/silent" Impersonate="no" Return="ignore" Execute="deferred" />
		<CustomAction Id="InstallSCService" Directory="APPPATH" ExeCommand='"[APPPATH]server\squeezecenter.exe" --install auto' Impersonate="no" Return="ignore" Execute="deferred" />

		<CustomAction Id="UnInstallSC" Directory="APPPATH" ExeCommand="[UNINSTALLCOMMAND] /SUPPRESSMSGBOXES" Impersonate="no" Return="ignore" Execute="deferred" />
		
		<Property Id="OLDERVERSIONBEINGUPGRADED" Secure="yes" />
		<Property Id="NEWERVERSIONDETECTED" Secure="yes" />
		
		<Upgrade Id="$(var.UpgradeCode)">
			<UpgradeVersion Minimum="$(var.version)" 
							IncludeMinimum="no" 
							OnlyDetect="yes" 
							Property="NEWERVERSIONDETECTED" />
			<UpgradeVersion Minimum="0.0.0" 
							Maximum="$(var.version)"
							IncludeMinimum="yes"
							IncludeMaximum="no"
							Property="OLDERVERSIONBEINGUPGRADED" />
		</Upgrade>

		<InstallExecuteSequence>
			<RemoveExistingProducts After="InstallValidate" />
			<Custom Action="InstallSC" After="InstallInitialize">
				NOT REMOVE="ALL"
			</Custom>
			<Custom Action="InstallSCService" After="InstallSC">
				NOT REMOVE="ALL"
			</Custom>
			<Custom Action="UnInstallSC" Before="InstallFinalize">
				REMOVE="ALL"
			</Custom>
		</InstallExecuteSequence>

	</Product>

</Wix>